<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>深入理解 Asyncio，从零开始构建你自己的并发调度器 - 黄波的博客</title><meta name=author content="黄波"><meta name=author-link content="https://boh5.com"><meta name=description content="Python 并发实现的两种方式： 基于回调的实现 基于生成器(协程)的实现 下面将基于两个简单的例子分别介绍如何从 0 开始以两种方式实现自己的异步框架： 相互独"><meta name=keywords content="Python,Python3,Asyncio,Async,并发,协程,EventLoop"><meta itemprop=name content="深入理解 Asyncio，从零开始构建你自己的并发调度器"><meta itemprop=description content="Python 并发实现的两种方式： 基于回调的实现 基于生成器(协程)的实现 下面将基于两个简单的例子分别介绍如何从 0 开始以两种方式实现自己的异步框架： 相互独"><meta itemprop=datePublished content="2022-08-28T15:00:00+08:00"><meta itemprop=dateModified content="2022-08-29T23:35:00+08:00"><meta itemprop=wordCount content="7674"><meta itemprop=image content="https://boh5.com/apple-touch-icon.png"><meta itemprop=keywords content="Python,Python3,Asyncio,Async,并发,协程,EventLoop,"><meta property="og:title" content="深入理解 Asyncio，从零开始构建你自己的并发调度器"><meta property="og:description" content="Python 并发实现的两种方式： 基于回调的实现 基于生成器(协程)的实现 下面将基于两个简单的例子分别介绍如何从 0 开始以两种方式实现自己的异步框架： 相互独"><meta property="og:type" content="article"><meta property="og:url" content="https://boh5.com/posts/blogs/basis/build-your-own-async/"><meta property="og:image" content="https://boh5.com/apple-touch-icon.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-28T15:00:00+08:00"><meta property="article:modified_time" content="2022-08-29T23:35:00+08:00"><meta property="og:site_name" content="黄波的博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://boh5.com/apple-touch-icon.png"><meta name=twitter:title content="深入理解 Asyncio，从零开始构建你自己的并发调度器"><meta name=twitter:description content="Python 并发实现的两种方式： 基于回调的实现 基于生成器(协程)的实现 下面将基于两个简单的例子分别介绍如何从 0 开始以两种方式实现自己的异步框架： 相互独"><meta name=application-name content="黄波的博客"><meta name=apple-mobile-web-app-title content="黄波的博客"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://boh5.com/posts/blogs/basis/build-your-own-async/><link rel=prev href=https://boh5.com/posts/notes/networks/web-protocol/geekbang/1-http1-protocol/><link rel=next href=https://boh5.com/posts/tips/languages/golang/common/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><meta name=google-site-verification content="3_Zf27e0mNtTIsBWn36hi_d4KTxPd2Zh1dsZMVnKK8k"><meta name=baidu-site-verification content="code-VsfDko5mls"><meta name=360-site-verification content="1a8490494ad7f3fe3e0f7e4a61ce0775"><meta name=sogou_site_verification content="X0yE1Xexzf"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"深入理解 Asyncio，从零开始构建你自己的并发调度器","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/boh5.com\/posts\/blogs\/basis\/build-your-own-async\/"},"genre":"posts","keywords":"Python, Python3, Asyncio, Async, 并发, 协程, EventLoop","wordcount":7674,"url":"https:\/\/boh5.com\/posts\/blogs\/basis\/build-your-own-async\/","datePublished":"2022-08-28T15:00:00+08:00","dateModified":"2022-08-29T23:35:00+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"黄波"},"description":""}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/ title=黄波的博客><img class="lazyload logo" src=/svg/loading.min.svg data-src=/apple-touch-icon.png data-srcset="/apple-touch-icon.png, /apple-touch-icon.png 1.5x, /apple-touch-icon.png 2x" data-sizes=auto alt=黄波的博客 title=黄波的博客><span class=header-title-text>黄波的博客</span></a><span class=header-subtitle>开发、学习、生活、技术分享</span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/><i class='fa-solid fa-book fa-fw fa-sm'></i> 学习笔记</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=黄波的博客><img class="lazyload logo" src=/svg/loading.min.svg data-src=/apple-touch-icon.png data-srcset="/apple-touch-icon.png, /apple-touch-icon.png 1.5x, /apple-touch-icon.png 2x" data-sizes=auto alt=/apple-touch-icon.png title=/apple-touch-icon.png><span class=header-title-text>黄波的博客</span></a><span class=header-subtitle>开发、学习、生活、技术分享</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/><i class='fa-solid fa-book fa-fw fa-sm'></i> 学习笔记</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>深入理解 Asyncio，从零开始构建你自己的并发调度器</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://boh5.com title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><i class="fa-solid fa-user-circle"></i>
黄波</a></span>
<span class=post-category>收录于 <a href=/categories/blog/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Blog</a></span></div><div class=post-meta-line><span title="2022-08-28 15:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-08-28>2022-08-28</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 7674 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 16 分钟&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="深入理解 Asyncio，从零开始构建你自己的并发调度器">
<i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-同步方式>1. 同步方式</a></li><li><a href=#2-基于回调的并发调度>2. 基于回调的并发调度</a></li><li><a href=#3-生产者-消费者模型>3. 生产者-消费者模型</a><ul><li><a href=#31-多线程调度>3.1 多线程调度</a></li><li><a href=#32-回调调度>3.2 回调调度</a></li></ul></li><li><a href=#4-基于生成器的并发调度>4. 基于生成器的并发调度</a><ul><li><a href=#41-相互独立的函数调度>4.1 相互独立的函数调度</a><ul><li><a href=#411-基本实现>4.1.1 基本实现</a></li><li><a href=#412-更优雅的写法>4.1.2 更优雅的写法</a></li><li><a href=#413-真正并发起来>4.1.3 真正并发起来</a></li></ul></li><li><a href=#42-生产者-消费者模型调度>4.2 生产者-消费者模型调度</a></li></ul></li><li><a href=#5-更类似-asyncio-的方式>5. 更类似 Asyncio 的方式</a></li><li><a href=#6-并发-io>6. 并发 I/O</a></li><li><a href=#7-参考资料>7. 参考资料</a></li></ul></nav></div></div><div class=content id=content><p>Python 并发实现的两种方式：</p><ol><li>基于回调的实现</li><li>基于生成器(协程)的实现</li></ol><p>下面将基于两个简单的例子分别介绍如何从 0 开始以两种方式实现自己的异步框架：</p><ol><li>相互独立的函数的并发</li><li>生产者消费者模式的并发</li></ol><h2 id=1-同步方式>1. 同步方式</h2><p>有两个相互独立的函数：</p><ol><li><code>def countdown(n)</code>：从 n 开始往下打印到 0</li><li><code>def countup(n)</code>：从 0 开始向上打印到 n - 1</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>countdown</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Down&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>countup</span><span class=p>(</span><span class=n>stop</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Up&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><p>以同步方式运行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>countdown</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>countup</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Down <span class=m>5</span>
</span></span><span class=line><span class=cl>Down <span class=m>4</span>
</span></span><span class=line><span class=cl>Down <span class=m>3</span>
</span></span><span class=line><span class=cl>Down <span class=m>2</span>
</span></span><span class=line><span class=cl>Down <span class=m>1</span>
</span></span><span class=line><span class=cl>Up <span class=m>0</span>
</span></span><span class=line><span class=cl>Up <span class=m>1</span>
</span></span><span class=line><span class=cl>Up <span class=m>2</span>
</span></span><span class=line><span class=cl>Up <span class=m>3</span>
</span></span><span class=line><span class=cl>Up <span class=m>4</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以以多线程的方式进行并发调度：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>countdown</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>5</span><span class=p>,))</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>countup</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>5</span><span class=p>,))</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=2-基于回调的并发调度>2. 基于回调的并发调度</h2><p>如果不考虑多线程的方式，我们来实现自己的并发调度器。
首先，我们来实现一个调度器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>  <span class=c1># 准备好执行的 function 队列</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 等待执行的 function 优先级队列</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_soon</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;将 func 加入 ready 队列&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_later</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;将 func 加入 sleeping 队列&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>deadline</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>delay</span>  <span class=c1># 计算执行时间，将其作为优先级</span>
</span></span><span class=line><span class=cl>        <span class=n>heapq</span><span class=o>.</span><span class=n>heappush</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>,</span> <span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=n>func</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 取出等待队列中优先级最高的(执行时间最近的)，放入 ready 队列</span>
</span></span><span class=line><span class=cl>                <span class=n>deadline</span><span class=p>,</span> <span class=n>func</span> <span class=o>=</span> <span class=n>heapq</span><span class=o>.</span><span class=n>heappop</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>delta</span> <span class=o>=</span> <span class=n>deadline</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>  <span class=c1># 从 ready 队列中取出一个函数执行</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>通过上面的代码，我们实现了一个基本的调度器，可以实现异步调度的功能：</p><ul><li>要立即运行一个函数，我们并不直接调用，而是调用 <code>call_soon</code> 方法，将其加入 <code>ready</code> 队列，等待 <code>run</code> 方法调度</li><li>要延迟运行一个函数，调用 <code>call_later</code> 方法</li></ul><p>其中 <code>run</code> 方法是调度的核心，它的执行逻辑如下：</p><ul><li>当 <code>ready</code> 队列或 <code>sleeping</code> 队列有待执行函数时，循环取出并执行</li><li>首先从 <code>ready</code> 队列取出并执行</li><li><code>ready</code> 队列为空后，从 <code>sleeping</code> 队列取出最先执行的函数，放入 <code>ready</code> 队列</li></ul><p>但我们的调度器还有点问题，如果两个函数的 <code>deadline</code> 一样，则会报错:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>TypeError: <span class=s1>&#39;&lt;&#39;</span> not supported between instances of <span class=s1>&#39;function&#39;</span> and <span class=s1>&#39;function&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>这是由于 <code>heappush</code> 方法将首先比较 <code>(deadline, func)</code> 这个 tuple 中的第一个元素 <code>deadline</code>，当 <code>dealine</code> 相同的时候，会比较第二个元素，但第二个元素是一个函数，不能做比较。</p><p>要解决这个问题，我们可以在 <code>(deadline, func)</code> 这个 tuple 中加一个自增的量 <code>sequence</code>，变成 <code>(deadline, sequence, func)</code>，这样如果两个函数的 <code>deadline</code> 相同，则会依入队顺序排序</p><p>完整代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>  <span class=c1># 准备好执行的 function 队列</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 等待执行的 function 优先级队列</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>=</span> <span class=mi>0</span>  <span class=c1># 自增量，避免 heappush 抛异常</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_soon</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;将 func 加入 ready 队列&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_later</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;将 func 加入 sleeping 队列&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>deadline</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>delay</span>  <span class=c1># 计算执行时间，将其作为优先级</span>
</span></span><span class=line><span class=cl>        <span class=n>heapq</span><span class=o>.</span><span class=n>heappush</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>,</span> <span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span><span class=p>,</span> <span class=n>func</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 取出等待队列中优先级最高的(执行时间最近的)，放入 ready 队列</span>
</span></span><span class=line><span class=cl>                <span class=n>deadline</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>func</span> <span class=o>=</span> <span class=n>heapq</span><span class=o>.</span><span class=n>heappop</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>delta</span> <span class=o>=</span> <span class=n>deadline</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>  <span class=c1># 从 ready 队列中取出一个函数执行</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>这时，我们必须修改我们的 <code>countup</code> 和 <code>countdown</code> 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>countdown</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Down&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># time.sleep(4)  # 不要再使用阻塞的代码</span>
</span></span><span class=line><span class=cl>        <span class=n>sched</span><span class=o>.</span><span class=n>call_later</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>countdown</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>  <span class=c1># 要传递函数，而不能传递调用</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>countup</span><span class=p>(</span><span class=n>stop</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_run</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Up&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># time.sleep(1) # 不要再使用阻塞的代码</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>call_later</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>_run</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_run</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>去掉循环，改成回调，每次打印完成后，把下一个函数送入队列</li><li>阻塞的代码<code>time.sleep()</code> 去掉，改为 <code>call_later()</code> 控制调度时机</li></ul><p>调度函数，启动循环：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>countdown</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>countup</span><span class=p>(</span><span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>输出如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Down <span class=m>5</span>
</span></span><span class=line><span class=cl>Up <span class=m>0</span>
</span></span><span class=line><span class=cl>Up <span class=m>1</span>
</span></span><span class=line><span class=cl>Up <span class=m>2</span>
</span></span><span class=line><span class=cl>Up <span class=m>3</span>
</span></span><span class=line><span class=cl>Down <span class=m>4</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>可以看出，的确并发的运行了我们的两个函数。</p><h2 id=3-生产者-消费者模型>3. 生产者-消费者模型</h2><h3 id=31-多线程调度>3.1 多线程调度</h3><p>下面我们来看看多线程的生产者-消费者调度，代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>queue</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producing&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>  <span class=c1># 关闭信号</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>item</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consuming&#39;</span><span class=p>,</span> <span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consumer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>  <span class=c1># Thread-safe queue</span>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>producer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>consumer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>q</span><span class=p>,))</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>这个实现很简单，生产者每隔一秒往队列 put 一个消息，消费者从队列取出并打印，不再赘述</p><h3 id=32-回调调度>3.2 回调调度</h3><p>下面我们来看看，如何使用我们的 <code>Scheduler</code> 来调度生产者消费者，从而实现并发。</p><p>生产者-消费者模型相比独立的两个函数的调度多了一个队列来传递消息，因此我们必须要自己实现一个满足我们的回调的设计的队列，代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sched</span> <span class=o>=</span> <span class=n>Scheduler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QueueClosed</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;用于消息和异常的封装&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>exc</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>exc</span> <span class=o>=</span> <span class=n>exc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>result</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>exc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=bp>self</span><span class=o>.</span><span class=n>exc</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AsyncQueue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;实现回调调度的队列&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>  <span class=c1># 等待消息的消费者</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># 队列是否已关闭</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;关闭队列，让所有等待的消费者立即执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>func</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;传入消息，如果有等待的消费者，立即取出一个并执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>func</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>callback</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;取出消息，并调用 callback，如果没有消息，则将消费者 (callback) 放入等待队列&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>  <span class=c1># 有消息，立即调度</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>callback</span><span class=p>(</span><span class=n>Result</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>popleft</span><span class=p>())))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>  <span class=c1># 队列已关闭，Result 抛出一个异常</span>
</span></span><span class=line><span class=cl>                <span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>callback</span><span class=p>(</span><span class=n>Result</span><span class=p>(</span><span class=n>exc</span><span class=o>=</span><span class=n>QueueClosed</span><span class=p>())))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>  <span class=c1># 没有 item 时，不要阻塞，将自己放入等待队列，直到下一个消息到达，</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>callback</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>我们实现了一个 <code>Result</code> 类，以封装队列关闭的异常和取出的消息，使其有统一的接口，具体用法将在下面看到</p><p>我们实现了一个 <code>AsnyncQueue</code> 类，以配合我们的 <code>Scheduler</code> 完成异步调度：</p><ul><li><code>close</code> 方法用于关闭队列，并把所有等待的消费者立即调度</li><li><code>put</code> 方法将消息传入队列，传入的时候，如果有在队列中等待的消费者，因把它立即调度</li><li><code>get</code> 方法将消息取出，并传入 <code>callback</code> 进行调用，这里是我们回调的重点。回调的基本思想是：传入回调函数，等待资源就绪后，立即调用回调函数，因此我们要把消费者传入 <code>get</code> 方法，而不是直接返回一条消息，供调用者使用</li></ul><p>同样，我们也要修改上一节的生产者和消费者函数，由于我们要采用回调的方式，生产者和消费者中的循环都要改为回调，在消费者中，还要把自己传入队列，等待资源就绪后调用。</p><p>修改后的生产者和消费者函数如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_run</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>n</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producing&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>call_later</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>_run</span><span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>  <span class=c1># 取消循环，改为回调</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_run</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_consume</span><span class=p>(</span><span class=n>result</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>  <span class=c1># 由于对消息进行了封装，要通过该方法取出消息或抛出异常</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consuming&#39;</span><span class=p>,</span> <span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>QueueClosed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consumer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>callback</span><span class=o>=</span><span class=n>_consume</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>AsyncQueue</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>由于采用了回调，很难理解这段代码，我们不妨举例说明：</p><ul><li>当 <code>producer</code> 首次被调用时，将运行 <code>_run</code> 函数，参数 <code>n = 0</code>，接着我们把 <code>0</code> 放入 <code>AsyncQueue</code> 的队列中，再接着往 <code>Scheduler</code> 传入下一个等待调度的函数 <code>_run</code>，参数 <code>n + 1</code>，这里比较容易理解</li><li>当 <code>consumer</code> 首次被调用时，我们调用 <code>AsyncQueue</code> 的 <code>get</code> 方法，传入 <code>callback=_consume</code>，由于已经有一条消息 <code>0</code>，<code>_consume</code> 立即运行(并不一定是立即，取决于 <code>Scheduler</code> 中 <code>ready</code> 队列的状态，当然此时是立即执行的，因为在此之前 <code>ready</code> 队列是空的)，<code>result.result()</code> 返回 <code>0</code>，因此立即打印 <code>Consuming 0</code>，并调用 <code>sched.call_soon(lambda: consumer(q))</code> 再次将自己加入 <code>ready</code> 队列，将立即被调度</li><li>这时由于 <code>producer</code> 会等待 1s 后调用，此时还没有消息，因此在 <code>AsyncQueue</code> 的 <code>get</code> 方法中，会把 <code>_consume</code> 加入 <code>waiting</code> 队列</li><li>直到下一个 <code>_run</code> 运行，将 <code>1</code> 加入 <code>items</code> 中，并在 <code>AsyncQueue</code> 的 <code>put</code> 方法中将上一把加入 <code>waiting</code> 队列的消费唤醒并调度</li><li>重复以上过程，即实现了生产者-消费者的异步调度</li></ul><p>注意：当我们使用基于回调的异步调度时，不能在我们的生产者或消费者中引入<strong>阻塞</strong>的代码，否则会在调度器的 <code>run()</code> 方法中阻塞住整个循环，并且要把所有的<strong>循环</strong>，改为回调形式</p><p>我们可以看出，基于回调的并发调度有诸多缺点：</p><ul><li>代码相比同步形式，结构上有了很大改变</li><li>正因此改变使其变得难以理解</li><li>如果回调层数增加，将更一步的难以阅读和理解</li></ul><h2 id=4-基于生成器的并发调度>4. 基于生成器的并发调度</h2><p>正是由于回调难以理解，代码相比同步方式改动太大，我们将实现基于生成器(协程)的并发调度。</p><p>对于生成器不了解的童鞋建议 Google 一下再来接着看</p><h3 id=41-相互独立的函数调度>4.1 相互独立的函数调度</h3><h4 id=411-基本实现>4.1.1 基本实现</h4><p>和之前一样，我们也要实现一个调度器，先看一下最基本的实现:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># Current executing generator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>new_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>next</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span> <span class=o>=</span> <span class=n>Scheduler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>countdown</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Down&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>countup</span><span class=p>(</span><span class=n>stop</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Up&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>countdown</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>countup</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>这是一个基本结构，我们通过 <code>new_task</code> 方法将生成器放入队列，调用 <code>run()</code> 方法运行调度器后，循环的从 <code>ready</code> 队列取出生成器，调用 <code>next</code> 方法使其运行到下一个 <code>yield</code> 处，然后我们将生成器放回 <code>ready</code> 队列等待下一次调用，直到生成器抛出 <code>StopIteration</code> 异常。</p><p>由于我们的生成器中有阻塞代码 <code>time.sleep</code>，他并没有真正并发起来，但我们的调度器的基本结构就是这样的：循环调度生成器。稍后我们实现一个不阻塞的 <code>sleep</code> 即可实现并发(类似的在基于回调的调度中是由 <code>call_later</code> 实现的)。</p><p>此处的关键点在于：我们的 <code>countdown</code> 和 <code>countup</code> 函数和原来同步的函数除了多了一个 <code>yield</code> 以外没什么区别，相当容易阅读和理解。</p><h4 id=412-更优雅的写法>4.1.2 更优雅的写法</h4><p>毕竟多了个 <code>yield</code> 还是不太好看，他唯一的功能就是暂停函数的执行，交出控制权。</p><p>下面我们将使用协程来代替生成器，简单来讲使用 <code>async def</code> 定义的函数就是一个协程，其中可以使用 <code>await</code> 调用其他协程或 <code>Awaitable</code> 对象，但归根结底，我们还是需要一个 <code>yield</code> 来暂停函数执行，交出控制权。</p><p>实现方式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Awaitable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Awaitable 对象&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__await__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Awaitable 对象中，__await__ 方法要返回一个生成器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>switch</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Awaitable</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># Current executing generator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>new_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># next(self.current)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span> <span class=o>=</span> <span class=n>Scheduler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>countdown</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Down&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>countup</span><span class=p>(</span><span class=n>stop</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Up&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>countdown</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>countup</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>我们把生成器改为了协程，并在其中 <code>await</code> 一个 <code>Awaitable</code> 对象，来暂停协程运行。当运行到 <code>await switch()</code> 时，会进入 <code>Awaitable</code> 的 <code>__await__</code> 方法，执行到 <code>yield</code> 时，暂停函数执行</p><p>由于改用了协程，因此原本的唤醒方式 <code>next(generator)</code> 要改为 <code>corotine.send(None)</code>，即 <code>self.current.send(None)</code></p><h4 id=413-真正并发起来>4.1.3 真正并发起来</h4><p>我们将实现非阻塞的 <code>sleep</code> 方法来实现真正的并发，代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>heapq</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Awaitable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__await__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>switch</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Awaitable</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># 正在运行的 coroutine</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>new_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>coro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>coro</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>sleep</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;将当前协程加入 sleeping 队列，并从 ready 队列删除&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>deadline</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>delay</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>heapq</span><span class=o>.</span><span class=n>heappush</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>,</span> <span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># 让当前 coroutine 不要再被加入 ready 队列</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>  <span class=c1># Switch tasks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>  <span class=c1># 尝试从 sleeping 队列唤醒一个 coroutine</span>
</span></span><span class=line><span class=cl>                <span class=n>deadline</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>coro</span> <span class=o>=</span> <span class=n>heapq</span><span class=o>.</span><span class=n>heappop</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>)</span>  <span class=c1># 取出最近的一个协程</span>
</span></span><span class=line><span class=cl>                <span class=n>delta</span> <span class=o>=</span> <span class=n>deadline</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=c1># 如果还不到时间，就阻塞等待，因为这个是最早要执行的协程了，可以阻塞等待</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>coro</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># Drive as a generator</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span> <span class=o>=</span> <span class=n>Scheduler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>countdown</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Down&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>countup</span><span class=p>(</span><span class=n>stop</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Up&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>countdown</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>countup</span><span class=p>(</span><span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Down <span class=m>5</span>
</span></span><span class=line><span class=cl>Up <span class=m>0</span>
</span></span><span class=line><span class=cl>Up <span class=m>1</span>
</span></span><span class=line><span class=cl>Up <span class=m>2</span>
</span></span><span class=line><span class=cl>Up <span class=m>3</span>
</span></span><span class=line><span class=cl>Down <span class=m>4</span>
</span></span><span class=line><span class=cl>Up <span class=m>4</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>在 <code>countdown</code> 和 <code>countup</code> 中调用 <code>shced.sleep(1)</code> 类似我们调用 <code>asyncio.sleep(1)</code> 这里已经有一些 <code>asyncio</code> 的影子了。</p><p>当我们的调度器运行到 <code>sleep</code> 方法时，<code>self.corrent</code> 就是当前运行的协程 <code>countdown</code> 或 <code>countup</code>，进入 <code>sleep</code> 后，将其加入 <code>sleeping</code> 队列，并将 <code>self.current</code> 置为 <code>None</code> 以使其不再被加入 <code>ready</code> 队列</p><p>至此，我们的基于协程的并发调度已经完成。可以看出，我们原本的代码逻辑完全没有变化，只是将普通函数变成了协程(<code>async</code> 和 <code>await</code> 语法)，并把 <code>time.sleep()</code> 换成了我们的非阻塞的 <code>sched.sleep()</code></p><h3 id=42-生产者-消费者模型调度>4.2 生产者-消费者模型调度</h3><p>从<a href=#3-%e7%94%9f%e4%ba%a7%e8%80%85-%e6%b6%88%e8%b4%b9%e8%80%85%e6%a8%a1%e5%9e%8b>#第 3 节</a> 我们可以看出，要实现生产者-消费者模型，仅仅需要实现一个队列即可。我们将以类似的方式实现一个队列：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>QueueClosed</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AsyncQueue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sched</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>  <span class=c1># Put myself to sleep</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># &#34;Disappear&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>  <span class=c1># Switch to another task</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>同<a href=#3-%e7%94%9f%e4%ba%a7%e8%80%85-%e6%b6%88%e8%b4%b9%e8%80%85%e6%a8%a1%e5%9e%8b>#第 3 节</a>类似，不再赘述，要注意在 <code>get</code> 方法中，与上一节的 <code>sleep</code> 类似，将协程放入等待队列后，要把调度器的 <code>current</code> 置为 <code>None</code> 避免其再次被加入 <code>ready</code> 队列</p><blockquote><p>注意，此处 <code>put</code> 方法完全可以不是协程，此处这样写只是为了和 <code>get</code> 方法对应。</p></blockquote><p>同样，我们的生产者-消费者代码也不需要太大改动，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producing&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>  <span class=c1># &#34;Sentinel&#34; to shut down</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=k>await</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>item</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consuming&#39;</span><span class=p>,</span> <span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>QueueClosed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consumer done&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>由于我们没有回调了，我们不再需要把 <code>consumer</code> 传入 <code>get</code> 方法，在其中以回调的方式调用，而是直接把消息返回出来。我们的代码相比同步的代码除了 <code>async</code> 和 <code>await</code> 没有太大变化，易于阅读和理解</p><p>完整代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>heapq</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># Current executing generator</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>new_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>coro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>coro</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>sleep</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># The current &#34;coroutine&#34; wants to sleep. How?</span>
</span></span><span class=line><span class=cl>        <span class=n>deadline</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>delay</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>heapq</span><span class=o>.</span><span class=n>heappush</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>,</span> <span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># 让当前 coroutine 不要再被加入 ready 队列</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>  <span class=c1># Switch tasks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>deadline</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>coro</span> <span class=o>=</span> <span class=n>heapq</span><span class=o>.</span><span class=n>heappop</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>delta</span> <span class=o>=</span> <span class=n>deadline</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>coro</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># Drive as a generator</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># next(self.current)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>  <span class=c1># 实际执行 coroutine 的位置</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span> <span class=o>=</span> <span class=n>Scheduler</span><span class=p>()</span>  <span class=c1># Background scheduler object</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Awaitable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__await__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>switch</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Awaitable</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QueueClosed</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AsyncQueue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sched</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>  <span class=c1># Put myself to sleep</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># &#34;Disappear&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>  <span class=c1># Switch to another task</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producing&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>  <span class=c1># &#34;Sentinel&#34; to shut down</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=k>await</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>item</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consuming&#39;</span><span class=p>,</span> <span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>QueueClosed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consumer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>AsyncQueue</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>我们再来讲一讲调度器启动后的执行过程：</p><ul><li><code>producer</code> 通过 <code>await q.put(n)</code> 传入一条消息 <code>0</code>，然后运行 <code>await sched.sleep(1)</code> 进入 <code>sleep</code> 方法，将 <code>producer</code> 协程加入 <code>sleeping</code> 队列</li><li><code>consumer</code> 取出 <code>0</code> 并打印，在 <code>run</code> 方法中再次将自己加入 <code>ready</code> 队列，此时 <code>producer</code> 还未唤醒，<code>consumer</code> 将立即执行</li><li><code>consumer</code> 执行到 <code>await q.get()</code>，但 <code>q</code> 中还没有消息，因此将 <code>consumer</code> 加入 <code>waiting</code> 队列</li><li><code>producer</code> 唤醒后，产生一条消息 <code>1</code>，并唤醒 <code>consumer</code></li><li>以此往复，直到 <code>producer</code> 关闭队列，<code>consumer</code> 打印最后一条消息，再次调度 <code>consumer</code> 时，<code>get</code> 中抛出异常，结束</li></ul><h2 id=5-更类似-asyncio-的方式>5. 更类似 Asyncio 的方式</h2><p>在 <code>asyncio</code> 中并不简单的是我们上述的完全基于协程的调度方式，也不是基于回调的。而是结合两者，通过对协程进行封装，最后交由回调进行调度。这也正是其难以理解之处。</p><p>下面我们将实现结合回调和协程的调度，<code>Scheduler</code> 如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Task</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;实现协程的封装，使其可以像回调一样被调度&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>coro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coro</span> <span class=o>=</span> <span class=n>coro</span>  <span class=c1># &#34;Wrapped coroutine&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Make it look like a callback</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Driving the coroutine as before</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>coro</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>sched</span><span class=o>.</span><span class=n>current</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>  <span class=c1># Functions ready to execute</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># Sleeping functions</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_soon</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_later</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>deadline</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>delay</span>  <span class=c1># Expiration time</span>
</span></span><span class=line><span class=cl>        <span class=c1># Priority queue</span>
</span></span><span class=line><span class=cl>        <span class=n>heapq</span><span class=o>.</span><span class=n>heappush</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>,</span> <span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span><span class=p>,</span> <span class=n>func</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Find the nearest deadline</span>
</span></span><span class=line><span class=cl>                <span class=n>deadline</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>func</span> <span class=o>=</span> <span class=n>heapq</span><span class=o>.</span><span class=n>heappop</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>delta</span> <span class=o>=</span> <span class=n>deadline</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>new_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>coro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Task</span><span class=p>(</span><span class=n>coro</span><span class=p>))</span>  <span class=c1># Wrapped coroutine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>sleep</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>call_later</span><span class=p>(</span><span class=n>delay</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>实现方式如下：</p><ol><li>在基于回调的调度器基础上添加 <code>new_task</code> 方法用于将协程加入调度器，并实现 <code>sleep</code> 方法，还多了一个 <code>self.current</code> 变量，用于记录当前协程</li><li>增加 <code>Task</code> 类，使协程像普通函数一样被调度：通过 <code>new_task</code> 传入的协程，都被封装在 <code>Task</code> 中，但 <code>Task</code> 被调用时，实际上使用 <code>self.coro.send(None)</code> 来启动协程</li></ol><p>其他地方，我们无需做更多更改，我们既可以写一个协程来让其调度，也可以把我们的函数协程回调形式，让其调度，完整代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>heapq</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>  <span class=c1># Functions ready to execute</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># Sleeping functions</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_soon</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_later</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>deadline</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>delay</span>  <span class=c1># Expiration time</span>
</span></span><span class=line><span class=cl>        <span class=c1># Priority queue</span>
</span></span><span class=line><span class=cl>        <span class=n>heapq</span><span class=o>.</span><span class=n>heappush</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>,</span> <span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span><span class=p>,</span> <span class=n>func</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Find the nearest deadline</span>
</span></span><span class=line><span class=cl>                <span class=n>deadline</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>func</span> <span class=o>=</span> <span class=n>heapq</span><span class=o>.</span><span class=n>heappop</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>delta</span> <span class=o>=</span> <span class=n>deadline</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>new_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>coro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Task</span><span class=p>(</span><span class=n>coro</span><span class=p>))</span>  <span class=c1># Wrapped coroutine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>sleep</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>call_later</span><span class=p>(</span><span class=n>delay</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Task</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;实现协程的封装，使其可以像回调一样被调度&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>coro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coro</span> <span class=o>=</span> <span class=n>coro</span>  <span class=c1># &#34;Wrapped coroutine&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Make it look like a callback</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Driving the coroutine as before</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>coro</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>sched</span><span class=o>.</span><span class=n>current</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span> <span class=o>=</span> <span class=n>Scheduler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Awaitable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__await__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>switch</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Awaitable</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QueueClosed</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AsyncQueue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Wait...</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sched</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>  <span class=c1># Put myself to sleep</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># &#34;Disappear&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>  <span class=c1># Switch to another task</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producing&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>  <span class=c1># &#34;Sentinel&#34; to shut down</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=k>await</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>item</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consuming&#39;</span><span class=p>,</span> <span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>QueueClosed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consumer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>AsyncQueue</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>countdown</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Down&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sched</span><span class=o>.</span><span class=n>call_later</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>countdown</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>countup</span><span class=p>(</span><span class=n>stop</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_run</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Up&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>call_later</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>_run</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_run</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>countdown</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>call_soon</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>countup</span><span class=p>(</span><span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=6-并发-io>6. 并发 I/O</h2><p>基于我们上述的基于回调组合基于协程的调度方式，我们可以为其增加并发 I/O 的实现，此处实现一个并发 socket 为例。</p><p>代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>heapq</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>select</span> <span class=kn>import</span> <span class=n>select</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Scheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>  <span class=c1># Functions ready to execute</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># Sleeping functions</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_read_waiting</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_write_waiting</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_soon</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call_later</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>deadline</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>delay</span>  <span class=c1># Expiration time</span>
</span></span><span class=line><span class=cl>        <span class=c1># Priority queue</span>
</span></span><span class=line><span class=cl>        <span class=n>heapq</span><span class=o>.</span><span class=n>heappush</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>,</span> <span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>sequence</span><span class=p>,</span> <span class=n>func</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_wait</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fileno</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Trigger func() when fileno is readable</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_read_waiting</span><span class=p>[</span><span class=n>fileno</span><span class=p>]</span> <span class=o>=</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write_wait</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fileno</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Trigger func() when fileno is writeable</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_write_waiting</span><span class=p>[</span><span class=n>fileno</span><span class=p>]</span> <span class=o>=</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_waiting</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>_write_waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Find the nearest deadline</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>deadline</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>func</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>timeout</span> <span class=o>=</span> <span class=n>deadline</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>timeout</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>timeout</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>timeout</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># Wait forever</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># Wait for I/O and sleep</span>
</span></span><span class=line><span class=cl>                <span class=n>can_read</span><span class=p>,</span> <span class=n>can_write</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>select</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_read_waiting</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_write_waiting</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=p>[],</span> <span class=n>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>fd</span> <span class=ow>in</span> <span class=n>can_read</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_read_waiting</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>fd</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>fd</span> <span class=ow>in</span> <span class=n>can_write</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_write_waiting</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>fd</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># Check for sleeping tasks</span>
</span></span><span class=line><span class=cl>                <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>now</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>heapq</span><span class=o>.</span><span class=n>heappop</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sleeping</span><span class=p>)[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>new_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>coro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Task</span><span class=p>(</span><span class=n>coro</span><span class=p>))</span>  <span class=c1># Wrapped coroutine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>sleep</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>call_later</span><span class=p>(</span><span class=n>delay</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recv</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sock</span><span class=p>,</span> <span class=n>maxbytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>read_wait</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>maxbytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>send</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sock</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>write_wait</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>accept</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sock</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>read_wait</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sock</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Task</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>coro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coro</span> <span class=o>=</span> <span class=n>coro</span>  <span class=c1># &#34;Wrapped coroutine&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Make it look like a callback</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Driving the coroutine as before</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>coro</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>sched</span><span class=o>.</span><span class=n>current</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span> <span class=o>=</span> <span class=n>Scheduler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Awaitable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__await__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>switch</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Awaitable</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QueueClosed</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AsyncQueue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>ready</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>popleft</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>QueueClosed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Wait...</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>waiting</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sched</span><span class=o>.</span><span class=n>current</span><span class=p>)</span>  <span class=c1># Put myself to sleep</span>
</span></span><span class=line><span class=cl>            <span class=n>sched</span><span class=o>.</span><span class=n>current</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># &#34;Disappear&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>switch</span><span class=p>()</span>  <span class=c1># Switch to another task</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producing&#39;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Producer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>  <span class=c1># &#34;Sentinel&#34; to shut down</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=k>await</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>item</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consuming&#39;</span><span class=p>,</span> <span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>QueueClosed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Consumer done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>tcp_server</span><span class=p>(</span><span class=n>addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>bind</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>accept</span><span class=p>(</span><span class=n>sock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>echo_handler</span><span class=p>(</span><span class=n>client</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>echo_handler</span><span class=p>(</span><span class=n>sock</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=mi>10000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>sched</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Got:&#39;</span> <span class=o>+</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Connection closed&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>AsyncQueue</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=mi>100</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>new_task</span><span class=p>(</span><span class=n>tcp_server</span><span class=p>((</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=mi>30000</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sched</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>下面我们讨论下重点部分：</p><ul><li><code>read_wait</code> 和 <code>write_wait</code> 方法将准备读写的文件句柄和准备调度的方法写入等待字典 <code>_read_waiting</code> 和 <code>_write_waiting</code></li><li><code>recv</code>、<code>send</code> 和 <code>accept</code> 方法将对应的 socket fd 加入等待字典中</li><li><code>run</code> 方法除了遍历 <code>ready</code> 和 <code>sleeping</code> 队列，还要遍历 <code>_read_waiting</code> 和 <code>_write_waiting</code> 字典</li><li><code>run</code> 方法中通过 <code>can_read, can_write, _ = select(self._read_waiting, self._write_waiting, [], timeout)</code> 找出准备好的 <code>fd</code>，并唤醒 <code>fd</code> 对应的方法，即 <code>recv</code>、<code>send</code> 和 <code>accept</code></li><li>在 <code>tcp_server</code> 中调用 <code>accept</code> 接受 socket 连接(异步的、并发的)，当由连接进入时，将 <code>echo_handler</code> 加入调度器，对当前 <code>client</code> 服务，这里没有阻塞，因此会继续监听下一个</li></ul><p>由此，我们的调度器 <code>Scheduler</code> 可以同时做生产者-消费者任务，并且 handle 多个 socket 连接，实现了真正的异步、并发</p><h2 id=7-参考资料>7. 参考资料</h2><blockquote><p>本文来源于<a href=https://www.youtube.com/user/dabeazllc target=_blank rel="external nofollow noopener noreferrer">David Beazley<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1"></i></a> 的视频 <a href="https://www.youtube.com/watch?v=Y4Gt3Xjd7G8" target=_blank rel="external nofollow noopener noreferrer">Build Your Own Async<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1"></i></a>，我在学习后，结合自己的理解写了本篇文章。我写的可能不够透彻，大家可以去原视频看看。</p><p>源代码: <a href=https://gist.github.com/dabeaz/f86ded8d61206c757c5cd4dbb5109f74 target=_blank rel="external nofollow noopener noreferrer">dabeaz/aproducer.py<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1"></i></a></p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2022-08-29 23:35:00">更新于 2022-08-29</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/blogs/basis/build-your-own-async/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://boh5.com/posts/blogs/basis/build-your-own-async/ data-title="深入理解 Asyncio，从零开始构建你自己的并发调度器" data-hashtags=Python,Python3,Asyncio,Async,并发,协程,EventLoop><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://boh5.com/posts/blogs/basis/build-your-own-async/ data-hashtag=Python><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://boh5.com/posts/blogs/basis/build-your-own-async/ data-title="深入理解 Asyncio，从零开始构建你自己的并发调度器" data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://boh5.com/posts/blogs/basis/build-your-own-async/ data-title="深入理解 Asyncio，从零开始构建你自己的并发调度器"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://boh5.com/posts/blogs/basis/build-your-own-async/ data-title="深入理解 Asyncio，从零开始构建你自己的并发调度器"><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://boh5.com/posts/blogs/basis/build-your-own-async/ data-title="深入理解 Asyncio，从零开始构建你自己的并发调度器" data-description><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://boh5.com/posts/blogs/basis/build-your-own-async/ data-title="深入理解 Asyncio，从零开始构建你自己的并发调度器" data-description><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://boh5.com/posts/blogs/basis/build-your-own-async/ data-title="深入理解 Asyncio，从零开始构建你自己的并发调度器"><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/tags/python/>Python</a>,&nbsp;<a href=/tags/python3/>Python3</a>,&nbsp;<a href=/tags/asyncio/>Asyncio</a>,&nbsp;<a href=/tags/async/>Async</a>,&nbsp;<a href=/tags/%E5%B9%B6%E5%8F%91/>并发</a>,&nbsp;<a href=/tags/%E5%8D%8F%E7%A8%8B/>协程</a>,&nbsp;<a href=/tags/eventloop/>EventLoop</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/notes/networks/web-protocol/geekbang/1-http1-protocol/ class=prev rel=prev title="Web 协议学习笔记(一) HTTP1 协议"><i class="fa-solid fa-angle-left fa-fw"></i>Web 协议学习笔记(一) HTTP1 协议</a>
<a href=/posts/tips/languages/golang/common/ class=next rel=next title="Golang Tips - 记录 Golang 开发中遇到的小问题和最佳实践">Golang Tips - 记录 Golang 开发中遇到的小问题和最佳实践<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=boh5/boh5.github.io data-repo-id=R_kgDOHr9Jag data-category=Announcements data-category-id=DIC_kwDOHr9Jas4CQ396 data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.102.3">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel="external nofollow noopener noreferrer" title="FixIt v0.2.16-RC"><img class=fixit-icon src=/images/fixit.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>
<a href=https://boh5.com target=_blank rel="external nofollow noopener noreferrer">黄波</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/boh5 title="在 GitHub 上找到我" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/lib/lunr/lunr.min.js defer></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js defer></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js defer></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/_custom.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y7BJE11JP4",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-Y7BJE11JP4" async></script></body></html>