<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>高级篇（三）Redis 原理篇（一）数据结构 - 黄波的博客</title><meta name=author content="黄波"><meta name=author-link content="https://dilless.github.io"><meta name=description content="1. 基本数据结构 1.1 动态字符串 SDS Redis 没有直接使用 C 语言中的字符串，因为 C 语言字符串存在很多问题： 获取字符串长度的需要通过运算 非二进制安全 不可修改 R"><meta name=keywords content="redis,数据库,缓存,实现原理,数据结构"><meta itemprop=name content="高级篇（三）Redis 原理篇（一）数据结构"><meta itemprop=description content="1. 基本数据结构 1.1 动态字符串 SDS Redis 没有直接使用 C 语言中的字符串，因为 C 语言字符串存在很多问题： 获取字符串长度的需要通过运算 非二进制安全 不可修改 R"><meta itemprop=datePublished content="2022-08-05T00:00:00+08:00"><meta itemprop=dateModified content="2022-08-06T16:03:00+08:00"><meta itemprop=wordCount content="4693"><meta itemprop=image content="https://dilless.github.io/apple-touch-icon.png"><meta itemprop=keywords content="redis,数据库,缓存,实现原理,数据结构,"><meta property="og:title" content="高级篇（三）Redis 原理篇（一）数据结构"><meta property="og:description" content="1. 基本数据结构 1.1 动态字符串 SDS Redis 没有直接使用 C 语言中的字符串，因为 C 语言字符串存在很多问题： 获取字符串长度的需要通过运算 非二进制安全 不可修改 R"><meta property="og:type" content="article"><meta property="og:url" content="https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/"><meta property="og:image" content="https://dilless.github.io/apple-touch-icon.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-05T00:00:00+08:00"><meta property="article:modified_time" content="2022-08-06T16:03:00+08:00"><meta property="og:site_name" content="黄波的博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dilless.github.io/apple-touch-icon.png"><meta name=twitter:title content="高级篇（三）Redis 原理篇（一）数据结构"><meta name=twitter:description content="1. 基本数据结构 1.1 动态字符串 SDS Redis 没有直接使用 C 语言中的字符串，因为 C 语言字符串存在很多问题： 获取字符串长度的需要通过运算 非二进制安全 不可修改 R"><meta name=application-name content="黄波的博客"><meta name=apple-mobile-web-app-title content="黄波的博客"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/><link rel=prev href=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/2-redis-best-practice/><link rel=next href=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/4-redis-principle-2-network/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><meta name=google-site-verification content="3_Zf27e0mNtTIsBWn36hi_d4KTxPd2Zh1dsZMVnKK8k"><meta name=baidu-site-verification content="code-VsfDko5mls"><meta name=360-site-verification content="1a8490494ad7f3fe3e0f7e4a61ce0775"><meta name=sogou_site_verification content="X0yE1Xexzf"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"高级篇（三）Redis 原理篇（一）数据结构","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/dilless.github.io\/posts\/notes\/databases\/redis\/itheima_redis_lesson\/advanced\/3-redis-principle-1-data-structure\/"},"genre":"posts","keywords":"redis, 数据库, 缓存, 实现原理, 数据结构","wordcount":4693,"url":"https:\/\/dilless.github.io\/posts\/notes\/databases\/redis\/itheima_redis_lesson\/advanced\/3-redis-principle-1-data-structure\/","datePublished":"2022-08-05T00:00:00+08:00","dateModified":"2022-08-06T16:03:00+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"黄波"},"description":""}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/ title=黄波的博客><img class="lazyload logo" src=/svg/loading.min.svg data-src=/apple-touch-icon.png data-srcset="/apple-touch-icon.png, /apple-touch-icon.png 1.5x, /apple-touch-icon.png 2x" data-sizes=auto alt=黄波的博客 title=黄波的博客><span class=header-title-text>黄波的博客</span></a><span class=header-subtitle>开发、学习、生活、技术分享</span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/><i class='fa-solid fa-book fa-fw fa-sm'></i> 学习笔记</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=黄波的博客><img class="lazyload logo" src=/svg/loading.min.svg data-src=/apple-touch-icon.png data-srcset="/apple-touch-icon.png, /apple-touch-icon.png 1.5x, /apple-touch-icon.png 2x" data-sizes=auto alt=/apple-touch-icon.png title=/apple-touch-icon.png><span class=header-title-text>黄波的博客</span></a><span class=header-subtitle>开发、学习、生活、技术分享</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/><i class='fa-solid fa-book fa-fw fa-sm'></i> 学习笔记</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>高级篇（三）Redis 原理篇（一）数据结构</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://dilless.github.io title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><i class="fa-solid fa-user-circle"></i>
黄波</a></span>
<span class=post-category>收录于 <a href=/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;学习笔记</a>&ensp;<a href=/categories/redis/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;redis</a></span></div><div class=post-meta-line><span title="2022-08-05 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-08-05>2022-08-05</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 4693 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="高级篇（三）Redis 原理篇（一）数据结构">
<i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-基本数据结构>1. 基本数据结构</a><ul><li><a href=#11-动态字符串-sds>1.1 动态字符串 SDS</a></li><li><a href=#12-intset>1.2 intset</a></li><li><a href=#13-dict>1.3 Dict</a></li><li><a href=#14-ziplist>1.4 ZipList</a></li><li><a href=#15-quicklist>1.5 QuickList</a></li><li><a href=#16-skiplist>1.6 SkipList</a></li><li><a href=#17-redisobject>1.7 RedisObject</a></li></ul></li><li><a href=#2-五种数据类型>2. 五种数据类型</a><ul><li><a href=#21-string>2.1 String</a></li><li><a href=#22-list>2.2 List</a></li><li><a href=#23-set>2.3 Set</a></li><li><a href=#24-zsetsortedset>2.4 ZSet(SortedSet)</a></li><li><a href=#25-hash>2.5 Hash</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=1-基本数据结构>1. 基本数据结构</h2><h3 id=11-动态字符串-sds>1.1 动态字符串 SDS</h3><p>Redis 没有直接使用 C 语言中的字符串，因为 C 语言字符串存在很多问题：</p><ul><li>获取字符串长度的需要通过运算</li><li>非二进制安全</li><li>不可修改</li></ul><p>Redis构建了一种新的字符串结构，称为简单动态字符串（Simple Dynamic String），简称SDS。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/1653984624671.png data-srcset="../images/1653984624671.png, ../images/1653984624671.png 1.5x, ../images/1653984624671.png 2x" data-sizes=auto alt=../images/1653984624671.png title=SDS></p><p>SDS 具备动态扩容能力，如果我们要给SDS追加一段字符串，首先会申请新内存空间，称为<strong>内存预分配</strong>，再把值写入：</p><ul><li>如果新字符串小于 1M，则新空间为扩展后字符串长度的两倍 + 1</li><li>如果新字符串大于 1M，则新空间为扩展后字符串长度 + 1M + 1</li></ul><p>SDS 优点：</p><ul><li>获取字符串长度时间复杂度为 O(1)</li><li>支持动态扩容</li><li>减少内存分配次数</li><li>二进制安全</li></ul><h3 id=12-intset>1.2 intset</h3><p>IntSet 是 Redis 中 set 集合的一种实现方式，基于整数数组来实现，并且具备长度可变、有序等特征。
结构如下：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/1653984923322.png data-srcset="../images/1653984923322.png, ../images/1653984923322.png 1.5x, ../images/1653984923322.png 2x" data-sizes=auto alt=../images/1653984923322.png title=IntSet></p><p>其中的 encoding 包含三种模式，表示存储的整数大小不同：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/1653984942385.png data-srcset="../images/1653984942385.png, ../images/1653984942385.png 1.5x, ../images/1653984942385.png 2x" data-sizes=auto alt=../images/1653984942385.png title="IntSet encoding"></p><p><strong><code>contents[]</code> 存指向实际数组其实位置的指针，数据编码由 encoding 决定</strong></p><p>为了方便查找，Redis 会将 intset 中所有的整数按照升序依次保存在contents数组中</p><p>我们向<code>encoding: INTSET_ENC_INT16</code>的 IntSet 添加一个数字：50000，这个数字超出了int16_t的范围，intset会自动升级编码方式到合适的大小，流程如下：</p><ul><li>升级编码为INTSET_ENC_INT32, 每个整数占4字节，并按照新的编码方式及元素个数扩容数组</li><li>倒序依次将数组中的元素拷贝到扩容后的正确位置（后面的先往后放，如果正序，前面的扩容，后面就被覆盖了）</li><li>将待添加的元素放入数组末尾或开头（新的更大bit的元素只能大于或小于现有所有元素）</li><li>最后，将inset的encoding属性改为INTSET_ENC_INT32，将length属性改为4</li></ul><p>总结：</p><ul><li>IntSet 中的元素唯一、有序</li><li>升级机制，节省内存空间</li><li>底层采用二分查找来查询，数据量不大的时候效率还行</li></ul><h3 id=13-dict>1.3 Dict</h3><p>Redis 键与值的映射关系正是通过 Dict 来实现的。 Dict由三部分组成，分别是：哈希表（DictHashTable）、哈希节点（DictEntry）、字典（Dict）</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/1653985570612.png data-srcset="../images/1653985570612.png, ../images/1653985570612.png 1.5x, ../images/1653985570612.png 2x" data-sizes=auto alt=../images/1653985570612.png title="Redis Dict 组成"></p><p>当我们向 Dict 添加键值对时，Redis首先根据key计算出hash值（h），然后利用 <code>h & sizemask</code>（相当于 <code>h % size</code>）来计算元素应该存储到数组中的哪个索引位置。</p><p>Dict 在每次新增键值对时都会检查负载因子（LoadFactor = used/size） ，满足以下两种情况时会触发哈希表扩容：</p><ul><li>哈希表的 LoadFactor >= 1，并且服务器没有执行 BGSAVE 或者 BGREWRITEAOF 等后台进程</li><li>哈希表的 LoadFactor > 5</li></ul><p>Dict 每次删除元素时，当 LoadFactor 小于 0.1 时，Dict 收缩。</p><p><strong>Dict的rehash</strong></p><p>不管是扩容还是收缩，必定会创建新的哈希表，导致哈希表的 size 和 sizemask 变化，而key的查询与 sizemask 有关。因此必须对哈希表中的每一个 key 重新计算索引，插入新的哈希表，这个过程称为 rehash。过程是这样的：</p><ol><li>计算新 hash 表的 realSize，值取决于当前要做的是扩容还是收缩：</li></ol><ul><li>如果是扩容，则新 size 为第一个大于等于 dict.ht[0].used + 1 的 2^n</li><li>如果是收缩，则新 size 为第一个大于等于 dict.ht[0].used 的 2^n（不得小于4）</li></ul><ol start=2><li>按照新的 realSize 申请内存空间，创建 dictht，并赋值给 dict.ht[1]</li><li>设置 dict.rehashidx = 0，标示开始 rehash</li><li><del>将 dict.ht[0]中的每一个 dictEntry 都 rehash 到 dict.ht[1]</del></li><li>在 rehash 过程中，新增操作，则直接写入 ht[1]，查询、修改和删除则会在 dict.ht[0] 和 dict.ht[1] 依次查找并执行。这样可以确保 ht[0] 的数据只减不增，随着rehash最终为空</li><li>将 dict.ht[1]赋值给 dict.ht[0]，给 dict.ht[1] 初始化为空哈希表，释放原来的 dict.ht[0] 的内存</li><li>将 rehashidx 赋值为 -1，代表rehash结束</li></ol><p><strong>总结</strong>：</p><p>Dict的结构：</p><ul><li>类似java的HashTable，底层是数组加链表来解决哈希冲突</li><li>Dict包含两个哈希表，ht[0]平常用，ht[1]用来rehash</li></ul><p>Dict的伸缩：</p><ul><li>当LoadFactor大于5或者LoadFactor大于1并且没有子进程任务时，Dict扩容</li><li>当LoadFactor小于0.1时，Dict收缩</li><li>扩容大小为第一个大于等于used + 1的2^n</li><li>收缩大小为第一个大于等于used 的2^n</li><li>Dict采用渐进式rehash，每次访问Dict时执行一次rehash</li><li>rehash时ht[0]只减不增，新增操作只在ht[1]执行，其它操作在两个哈希表</li></ul><h3 id=14-ziplist>1.4 ZipList</h3><p><strong>整体结构</strong></p><p>ZipList 是一种特殊的“双端链表” ，由一系列特殊编码的连续内存块组成。可以在任意一端进行压入/弹出操作, 并且该操作的时间复杂度为 O(1)。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/20220805192914.png data-srcset="../images/20220805192914.png, ../images/20220805192914.png 1.5x, ../images/20220805192914.png 2x" data-sizes=auto alt=../images/20220805192914.png title="ZipList 结构"></p><table><thead><tr><th><strong>属性</strong></th><th><strong>类型</strong></th><th><strong>长度</strong></th><th><strong>用途</strong></th></tr></thead><tbody><tr><td>zlbytes</td><td>uint32_t</td><td>4 字节</td><td>记录整个压缩列表占用的内存字节数</td></tr><tr><td>zltail</td><td>uint32_t</td><td>4 字节</td><td>记录压缩列表表尾节点距离压缩列表的起始地址有多少字节，通过这个偏移量，可以确定表尾节点的地址。</td></tr><tr><td>zllen</td><td>uint16_t</td><td>2 字节</td><td>记录了压缩列表包含的节点数量。 最大值为UINT16_MAX （65534），如果超过这个值，此处会记录为65535，但节点的真实数量需要遍历整个压缩列表才能计算得出。</td></tr><tr><td>entry</td><td>列表节点</td><td>不定</td><td>压缩列表包含的各个节点，节点的长度由节点保存的内容决定。</td></tr><tr><td>zlend</td><td>uint8_t</td><td>1 字节</td><td>特殊值 0xFF （十进制 255 ），用于标记压缩列表的末端。</td></tr></tbody></table><p><strong>ZipListEntry</strong></p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/1653986055253.png data-srcset="../images/1653986055253.png, ../images/1653986055253.png 1.5x, ../images/1653986055253.png 2x" data-sizes=auto alt=../images/1653986055253.png title=ZipListEntry></p><ul><li><p>previous_entry_length：前一节点的长度，占1个或5个字节。</p><ul><li>如果前一节点的长度小于254字节，则采用1个字节来保存这个长度值</li><li>如果前一节点的长度大于254字节，则采用5个字节来保存这个长度值，第一个字节为0xfe，后四个字节才是真实长度数据</li></ul></li><li><p>encoding：编码属性，记录content的数据类型（字符串还是整数）以及长度，占用1个、2个或5个字节</p></li><li><p>contents：负责保存节点的数据，可以是字符串或整数</p></li></ul><p>ZipList中所有存储长度的数值均采用<strong>小端字节序</strong>，即低位字节在前，高位字节在后。例如：数值0x1234，采用小端字节序后实际存储值为：0x3412</p><p><strong>Encoding</strong></p><p>ZipListEntry中的encoding编码分为字符串和整数两种：</p><ul><li>字符串：如果encoding是以“00”、“01”或者“10”开头，则证明content是字符串</li></ul><table><thead><tr><th><strong>编码</strong></th><th><strong>编码长度</strong></th><th><strong>字符串大小</strong></th></tr></thead><tbody><tr><td>|00pppppp|</td><td>1 bytes</td><td>&lt;= 63 bytes</td></tr><tr><td>|01pppppp|qqqqqqqq|</td><td>2 bytes</td><td>&lt;= 16383 bytes</td></tr><tr><td>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt|</td><td>5 bytes</td><td>&lt;= 4294967295 bytes</td></tr></tbody></table><ul><li>整数：如果encoding是以“11”开始，则证明content是整数，且encodin g固定只占用1个字节</li></ul><table><thead><tr><th><strong>编码</strong></th><th><strong>编码长度</strong></th><th><strong>整数类型</strong></th></tr></thead><tbody><tr><td>11000000</td><td>1</td><td>int16_t（2 bytes）</td></tr><tr><td>11010000</td><td>1</td><td>int32_t（4 bytes）</td></tr><tr><td>11100000</td><td>1</td><td>int64_t（8 bytes）</td></tr><tr><td>11110000</td><td>1</td><td>24位有符整数(3 bytes)</td></tr><tr><td>11111110</td><td>1</td><td>8位有符整数(1 bytes)</td></tr><tr><td>1111xxxx</td><td>1</td><td>直接在xxxx位置保存数值，范围从0001~1101(1 - 13)(因为0000、1110在上面占用了，0xff 是 ziplist 结束标识)，减1后结果为实际值(0 - 12)</td></tr></tbody></table><p><strong>ZipList的连锁更新问题</strong></p><p>假设我们有N个连续的、长度为250~253字节之间的entry，左边新增、删除都可能导致连锁更新的发生。</p><p><strong>总结：</strong></p><ul><li>压缩列表的可以看做一种连续内存空间的"双向链表"</li><li>列表的节点之间不是通过指针连接，而是记录上一节点和本节点长度来寻址，内存占用较低</li><li>如果列表数据过多，导致链表过长，可能影响查询性能</li><li>增或删较大数据时有可能发生连续更新问题</li></ul><h3 id=15-quicklist>1.5 QuickList</h3><p>它是一个双端链表，只不过链表中的每个节点都是一个 ZipList。</p><p>为了避免QuickList中的每个ZipList中entry过多，Redis提供了一个配置项：<code>list-max-ziplist-size</code>来限制。</p><p>由于读首尾比较多，QuickList 还可以对中间节点的 ZipList 进行压缩，通过 <code>list-compress-depth</code> 配置。</p><p><strong>总结</strong></p><p>QuickList的特点：</p><ul><li>是一个节点为ZipList的双端链表</li><li>节点采用ZipList，解决了传统链表的内存占用问题</li><li>控制了ZipList大小，解决连续内存空间申请效率问题</li><li>中间节点可以压缩，进一步节省了内存</li></ul><h3 id=16-skiplist>1.6 SkipList</h3><p>SkipList（跳表）本质是链表，但与传统链表相比有几点差异：</p><ul><li>元素按照升序排列存储</li><li>节点可能包含多个指针，指针跨度不同。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/1653986813240.png data-srcset="../images/1653986813240.png, ../images/1653986813240.png 1.5x, ../images/1653986813240.png 2x" data-sizes=auto alt=../images/1653986813240.png title=SkipList></p><p><strong>总结</strong></p><p>SkipList的特点：</p><ul><li>跳跃表是一个双向链表，每个节点都包含score和ele值</li><li>节点按照score值排序，score值一样则按照ele字典排序</li><li>每个节点都可以包含多层指针，层数是1到32之间的随机数</li><li>不同层指针到下一个节点的跨度不同，层级越高，跨度越大</li><li>增删改查效率与红黑树基本一致，实现却更简单</li></ul><h3 id=17-redisobject>1.7 RedisObject</h3><p>Redis中的任意数据类型的键和值都会被封装为一个RedisObject。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/1653986956618.png data-srcset="../images/1653986956618.png, ../images/1653986956618.png 1.5x, ../images/1653986956618.png 2x" data-sizes=auto alt=../images/1653986956618.png title=RedisObject></p><blockquote><p>String 类型每个对象都有一个头，占用内存，尽量用集合类型代替</p></blockquote><p><strong>11种编码</strong></p><table><thead><tr><th><strong>编号</strong></th><th><strong>编码方式</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>0</td><td>OBJ_ENCODING_RAW</td><td>raw编码动态字符串</td></tr><tr><td>1</td><td>OBJ_ENCODING_INT</td><td>long类型的整数的字符串</td></tr><tr><td>2</td><td>OBJ_ENCODING_HT</td><td>hash表（字典dict）</td></tr><tr><td>3</td><td>OBJ_ENCODING_ZIPMAP</td><td>已废弃</td></tr><tr><td>4</td><td>OBJ_ENCODING_LINKEDLIST</td><td>双端链表</td></tr><tr><td>5</td><td>OBJ_ENCODING_ZIPLIST</td><td>压缩列表</td></tr><tr><td>6</td><td>OBJ_ENCODING_INTSET</td><td>整数集合</td></tr><tr><td>7</td><td>OBJ_ENCODING_SKIPLIST</td><td>跳表</td></tr><tr><td>8</td><td>OBJ_ENCODING_EMBSTR</td><td>embstr的动态字符串</td></tr><tr><td>9</td><td>OBJ_ENCODING_QUICKLIST</td><td>快速列表</td></tr><tr><td>10</td><td>OBJ_ENCODING_STREAM</td><td>Stream流</td></tr></tbody></table><p><strong>5种数据类型</strong></p><table><thead><tr><th><strong>数据类型</strong></th><th><strong>编码方式</strong></th></tr></thead><tbody><tr><td>OBJ_STRING</td><td>int、embstr、raw</td></tr><tr><td>OBJ_LIST</td><td>LinkedList和ZipList(3.2以前)、QuickList（3.2以后）</td></tr><tr><td>OBJ_SET</td><td>intset、HT</td></tr><tr><td>OBJ_ZSET</td><td>ZipList、HT、SkipList</td></tr><tr><td>OBJ_HASH</td><td>ZipList、HT</td></tr></tbody></table><blockquote><p>BitMap, HyperLogLog 底层就是 String</p></blockquote><h2 id=2-五种数据类型>2. 五种数据类型</h2><h3 id=21-string>2.1 String</h3><ul><li>其基本编码方式是RAW，基于简单动态字符串（SDS）实现，存储上限为512mb。</li><li>如果存储的SDS长度小于44字节（实际内容长度，不包括 SDS head），则会采用 EMBSTR 编码，此时 <strong>object head</strong> 与 <strong>SDS</strong> 是一段连续空间（Redis Object 和 SDS 加一起不超过 64 字节）。申请内存时只需要调用一次内存分配函数，效率更高。</li><li>如果存储的字符串是整数值，并且大小在 LONG_MAX 范围内，则会采用 INT 编码：直接将数据保存在 RedisObject 的 ptr 指针位置（刚好 8 字节），不再需要 SDS 了。</li></ul><blockquote><p>使用 String 时尽量小于 44 字节，能用整数值尽量用整数；key 也是 String 类型，因此尽量不超过 44 字节。</p></blockquote><h3 id=22-list>2.2 List</h3><p>在 3.2 版本之后，Redis 统一采用 QuickList 来实现 List</p><h3 id=23-set>2.3 Set</h3><ul><li>为了查询效率和唯一性，set采用HT编码（Dict）。Dict中的key用来存储元素，value统一为null。</li><li>当存储的所有数据都是整数，并且元素数量不超过set-max-intset-entries时，Set 会采用 IntSet 编码，以节省内存</li><li>插入时，如果不满足 IntSet 条件，会进行编码转换</li></ul><h3 id=24-zsetsortedset>2.4 ZSet(SortedSet)</h3><p>通过 Dict 和 SkipList 实现：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/1653992172526.png data-srcset="../images/1653992172526.png, ../images/1653992172526.png 1.5x, ../images/1653992172526.png 2x" data-sizes=auto alt=../images/1653992172526.png title=ZSet></p><p>当元素数量不多时，HT和SkipList的优势不明显，而且更耗内存。因此zset还会采用ZipList结构来节省内存，不过需要同时满足两个条件：</p><ul><li>元素数量小于zset_max_ziplist_entries，默认值128</li><li>每个元素都小于zset_max_ziplist_value字节，默认值64</li></ul><p>ziplist本身没有排序功能，而且没有键值对的概念，因此需要有zset通过编码实现：</p><ul><li>ZipList是连续内存，因此score和element是紧挨在一起的两个entry， element在前，score在后</li><li>score越小越接近队首，score越大越接近队尾，按照score值升序排列</li></ul><p>添加元素时可能触发编码转换</p><h3 id=25-hash>2.5 Hash</h3><p>Hash结构默认采用ZipList编码，用以节省内存。 ZipList中相邻的两个entry 分别保存field和value</p><p>当数据量较大时，Hash结构会转为HT编码，也就是Dict，触发条件有两个：</p><ul><li>ZipList中的元素数量超过了hash-max-ziplist-entries（默认512）</li><li>ZipList中的任意entry大小超过了hash-max-ziplist-value（默认64字节）</li></ul><p>Redis的hash之所以这样设计，是因为当ziplist变得很⼤的时候，它有如下几个缺点：</p><ul><li>每次插⼊或修改引发的realloc操作会有更⼤的概率造成内存拷贝，从而降低性能。</li><li>⼀旦发生内存拷贝，内存拷贝的成本也相应增加，因为要拷贝更⼤的⼀块数据。</li><li>当ziplist数据项过多的时候，在它上⾯查找指定的数据项就会性能变得很低，因为ziplist上的查找需要进行遍历。</li></ul><p>总之，ziplist本来就设计为各个数据项挨在⼀起组成连续的内存空间，这种结构并不擅长做修改操作。⼀旦数据发⽣改动，就会引发内存realloc，可能导致内存拷贝。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2022-08-06 16:03:00">更新于 2022-08-06</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/ data-title="高级篇（三）Redis 原理篇（一）数据结构" data-hashtags=redis,数据库,缓存,实现原理,数据结构><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/ data-hashtag=redis><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/ data-title="高级篇（三）Redis 原理篇（一）数据结构" data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/ data-title="高级篇（三）Redis 原理篇（一）数据结构"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/ data-title="高级篇（三）Redis 原理篇（一）数据结构"><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/ data-title="高级篇（三）Redis 原理篇（一）数据结构" data-description><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/ data-title="高级篇（三）Redis 原理篇（一）数据结构" data-description><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://dilless.github.io/posts/notes/databases/redis/itheima_redis_lesson/advanced/3-redis-principle-1-data-structure/ data-title="高级篇（三）Redis 原理篇（一）数据结构"><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/tags/redis/>redis</a>,&nbsp;<a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>,&nbsp;<a href=/tags/%E7%BC%93%E5%AD%98/>缓存</a>,&nbsp;<a href=/tags/%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/>实现原理</a>,&nbsp;<a href=/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/>数据结构</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/notes/databases/redis/itheima_redis_lesson/advanced/2-redis-best-practice/ class=prev rel=prev title="高级篇（二）Redis 最佳实践"><i class="fa-solid fa-angle-left fa-fw"></i>高级篇（二）Redis 最佳实践</a>
<a href=/posts/notes/databases/redis/itheima_redis_lesson/advanced/4-redis-principle-2-network/ class=next rel=next title="高级篇（四）Redis 原理篇（二）网络模型">高级篇（四）Redis 原理篇（二）网络模型<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=dilless/dilless.github.io data-repo-id=R_kgDOHr9Jag data-category=Announcements data-category-id=DIC_kwDOHr9Jas4CQ396 data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.101.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel="external nofollow noopener noreferrer" title="FixIt v0.2.16-RC"><img class=fixit-icon src=/images/fixit.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>
<a href=https://dilless.github.io target=_blank rel="external nofollow noopener noreferrer">黄波</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/dilless title="在 GitHub 上找到我" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/lib/lunr/lunr.min.js defer></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js defer></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js defer></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/_custom.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y7BJE11JP4",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-Y7BJE11JP4" async></script></body></html>